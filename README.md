# 이건 뭐지? [What-is-this?]

<div align="center">
<img width="300" src="https://github.com/Sao-jung-listens-well/WIT/blob/main/Assets/Resources/pumpkin_gold.PNG?raw=true">

[![Hits](https://hits.seeyoufarm.com/api/count/incr/badge.svg?url=https%3A%2F%2Fgithub.com%2FSao-jung-listens-well%2FBackend.git&count_bg=%23F8F981&title_bg=%23CBA0EB&icon=&icon_color=%23E7E7E7&title=hits&edge_flat=false)](https://hits.seeyoufarm.com)
</div>

> **세종대학교 2023-1 캡스톤디자인및설계 '말잘듣는 사오정'**
<br>**개발 기간 : 2023.04 ~ 2023.05**

## 배포 주소
> **프론트** : https://github.com/Sao-jung-listens-well/WIT <br>
> **백엔드** : https://github.com/Sao-jung-listens-well/Backend.git <br>

## 개발팀
|                                       이승재                                        |                                       한보은                                        |                                       김한슬                                       |                                       박성하                                       |                                                                               
|:--------------------------------------------------------------------------------:|:--------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------:|:-------------------------------------------------------------------------------:|
| <img width="160px" src="https://avatars.githubusercontent.com/u/81508501?v=4" /> | <img width="160px" src="https://avatars.githubusercontent.com/u/81304917?v=4" /> | <img width="160px" src="https://avatars.githubusercontent.com/u/67732600?v=4"/> | <img width="160px" src="https://avatars.githubusercontent.com/u/67732143?v=4"/> |
|                      [@fghy788](https://github.com/fghy788)                      |                     [@BoeunHan](https://github.com/BoeunHan)                     |                      [@slcloe](https://github.com/slcloe)                       |                      [@www-castlehi-com](https://github.com/www-castlehi-com)                       |
|                                  프론트엔드 - AR 담당                                   |                               프론트엔드 - UI / 음성인식 담당                               |                                 프론트엔드 - 사물인식 담당                                 |                                     백엔드 담당                                      |

## 프로젝트 소개
<a style="color:#CBA0EB"><strong>사물인식, 음성인식, AR을 통해 주변과 상호작용할 수 있는 유아 한글 교육 어플리케이션</strong></a>입니다. <br>
현재, 한글 교육 시장에는 전문가가 강조하는 한글 교육 순서인 통글자 -> 자모음 순서를 지키는 어플리케이션이 많지 않을 뿐더러 주변과 상호작용을 할 수 있는 어플리케이션은 존재하지 않아 아쉬움이 있었습니다. <br>
그러한 이유로 사물인식 기능을 적용해 주변 사물을 통글자로 배우고, 말하기 연습을 하고 AR로 숨겨진 자모음을 찾아 배운 통글자를 조합하는 어플리케이션을 만들게 되었습니다. <br>
또한, 영어 기능을 넣어 한글을 배우고 싶은 외국인도 사용할 수 있도록 제작하였습니다.

This is a preschool Korean education application that allows interaction with the surroundings through object recognition, voice recognition, and AR. <br>
Currently, in the Korean education market, there are not many applications that follow the recommended Korean education sequence of teaching integrated letters first, followed by individual letters. Due to these reasons, we felt a sense of regret. <br>
Therefore, we have developed an application that incorporates object recognition to learn integrated letters through surrounding objects and allows practicing speaking by using AR to find hidden individual letters and combine them to form the learned integrated letters. <br>
Moreover, we have included an English feature to make the application usable for foreigners who are interested in learning Korean.

## 제공되는 기능
1. **부모페이지 기능** - 학습에 대한 분석값, 아이의 성취감을 위한 보상 기능 제공
2. **통글자 학습** - 사물인식을 통해 주변 사물을 통글자로 학습 가능
3. **음성 학습** - 음성 인식을 통해 통글자를 학습한 글자를 음성 학습할 수 있음
4. **자모음 학습** - AR을 통해 집안 곳곳에 숨겨진 자모음을 찾아 조합하며 학습할 수 있음
5. **난이도 시스템** - 일정 기준을 통과하면 음성, 자모음 학습이 해금되는 형식
6. **영어 제공** - 한글을 배우고 싶어하는 외국인을 위해 영어 번역 시스템 제공
<br>
<br>

**Our application supports the following component.**
1. **Parent Page** - This feature provides analysis of the child's learning progress and offers a reward system to enhance their sense of achievement.
2. **Integrated Letter Learning** - Through object recognition, children can learn integrated letters by identifying objects in their surroundings.
3. **Voice Learning** - Using voice recognition, children can practice the pronunciation of the integrated letters they have learned.
4. **Individual Letter Learning** - Through AR, children can search for hidden individual letters throughout the house and learn by combining them.
5. **Difficulty System** - The application includes a difficulty system where the unlocking of voice and individual letter learning is based on meeting certain criteria.
6. **English Support** - The application provides an English translation system for foreigners who are interested in learning Korean.

## 개발 환경

### Environment
![IntelliJ IDEA](https://img.shields.io/badge/IntelliJ%20IDEA-000000?style=for-the-badge&logo=IntelliJ%20IDEA&logoColor=white)
![Git](https://img.shields.io/badge/Git-F05032?style=for-the-badge&logo=Git&logoColor=white)
![Github](https://img.shields.io/badge/GitHub-181717?style=for-the-badge&logo=GitHub&logoColor=white)
![iTerm2](https://img.shields.io/badge/iTerm2-000000?style=for-the-badge&logo=iTerm2&logoColor=white)

### Development
![Spring Boot](https://img.shields.io/badge/Spring%20Boot-6DB33F?style=for-the-badge&logo=Spring%20Boot&logoColor=white)
![Amazon EC2](https://img.shields.io/badge/Amazon%20EC2-FF9900?style=for-the-badge&logo=Amazon%20EC2&logoColor=white)
![Amazon RDS](https://img.shields.io/badge/Amazon%20RDS-527FFF?style=for-the-badge&logo=Amazon%20RDS&logoColor=white)
![Jenkins](https://img.shields.io/badge/Jenkins-D24939?style=for-the-badge&logo=Jenkins&logoColor=white)
![NGINX](https://img.shields.io/badge/NGINX-009639?style=for-the-badge&logo=NGINX&logoColor=white) <br>
![Hibernate](https://img.shields.io/badge/Hibernate-59666C?style=for-the-badge&logo=Hibernate&logoColor=white)
![MariaDB](https://img.shields.io/badge/MariaDB-003545?style=for-the-badge&logo=MariaDB&logoColor=white)

### Communication
![Notion](https://img.shields.io/badge/Notion-000000?style=for-the-badge&logo=Notion&logoColor=white)
![Discord](https://img.shields.io/badge/Discord-5865F2?style=for-the-badge&logo=Discord&logoColor=white)

## 개발

### Dependency
- 비밀번호 암호화를 위한 Spring Security 사용 (BCryptPasswordEncoder())
- 간편한 개발을 위한 Lombok:annotation 사용
- RestAPI시 json 배열을 보내주기 위한 json 사용
- Spring JPA를 이용해 개발
- HQL 사용

### ERD
<img width="50%" src="https://user-images.githubusercontent.com/67732143/237047836-4ace6ae8-89dc-48db-8635-1912a91f3e6e.png"/>

### 프로젝트 구성
<img width="80%" src="https://user-images.githubusercontent.com/67732143/242218985-a5dbd919-a609-4c47-93dc-b1f8cdf0db08.jpg"/>

각 서비스 단에는 Transactional annotation을 이용하여 에러 발생 시 데이터베이스 복구 과정을 거침

#### Member
1. **Entity**
> 생일, 이름, 아이디, 비밀번호 저장
2. **Repository**
> CRUD, 아이디 조회
3. **Service, Controller**
> 회원가입, 로그인, 정보 업데이트, 회원탈퇴, 부모 페이지 로그인
4. **이외**
> LoginVo <br>
NoMemberException <br>
DuplicateMemberException <br>
CannotJoinException <br>
SecurityConfig

<br>
<br>

#### Word
1. **Entity**
> Member가 학습한 단어의 내용, 제공된 레벨, 성공한 레벨, 학습한 날짜
2. **Repository**
> CRUD, Member의 아이디로 조회, 제공된 레벨로 조회, 성공한 레벨로 조회, 학습한 날짜 기준 조회
3. **Service, Controller**
> 단어 학습, Member가 학습한 단어 모두 조회
4. **이외**
> LevelException <br>
NoWordException <br>
DateException

<br>
<br>

#### Analysis
1. **Entity**
> Member가 학습한 단어 개수, Member의 평균 난이도, Member의 Level당 성공률
2. **Repository**
> CRUD
3. **Service, Controller**
> 분석, 날짜 기준 분석, 평균 난이도 조회
4. **이외**
> LevelException <br>
NoAnalysisException <br>
DateException

<br>
<br>

#### Amends
1. **Entity**
> Member의 보상 내용, 목표 학습 단어 개수, 보상 수령까지 남은 학습 수
2. **Repository**
> CRUD
3. **Service, Controller**
> Amends 정보 input, Amends 정보 output, Amends 정보 리셋
4. **이외**
> LevelException <br>
NoAmendsException

<br>
<br>

### TDD
<img width="60%" src="https://user-images.githubusercontent.com/67732143/242228054-b1d80a02-5959-408b-8239-cf304125e947.jpg">

#### Member
1. **Repository**
> Create, Null Attribute, NotNull Attribute 테스트 <br>
> Read, 아이디 동일성, 비밀번호 동일성, 부모 비밀번호 동일성, 존재하지 않는 Member 조회 테스트 <br>
> Delete 테스트 <br>
> Update 테스트
2. **Service**
> CRUD 테스트 <br>
> 비밀번호 암호화, 부모 비밀번호 암호화 동일성 테스트 <br>
> 중복 아이디 회원가입 테스트 <br>
> 로그인 성공, 로그인 실패 (아이디, 비밀번호 각각), 부모 로그인 성공, 부모 로그인 실패 테스트 <br>
> 연관관계 Entity CRD (amends, analysis) 테스트
3. **Controller**
> 회원가입 성공, 회원가입 실패 테스트 <br>
> 로그인 성공, 로그인 실패 테스트 <br>
> 부모 로그인 성공 (amends, analysis 조회), 부모 로그인 실패 테스트

<br>
<br> 

#### Word
1. **Repository**
> Create, Null Attribute, NotNull Attribute 테스트 <br>
> Read, 존재하지 않는 Word 조회, 빈 Database 조회, Member Idx로 조회, 학습순서대로 조회, 난이도 기준 조회, 날짜 기준 조회, 기준 합성 조회 테스트 <br>
> Update 테스트 <br>
> Delete 테스트
2. **Service**
> CRUD 테스트 <br>
> 난이도 에러 테스트 <br>
> 레벨 조회 에러 테스트 <br>
> 날짜 조회 에러 테스트
3. **Controller**
> 단어 추가 테스트 <br>
> 단어 조회 테스트

<br>
<br>

#### Analysis
1. **Repository**
> Create, NotNull Attribute 테스트 <br>
> Read, 빈 Database 조회 테스트 <br>
> Update 테스트 <br>
> Delete 테스트
2. **Service**
> U 테스트 <br>
> 모든 단어 분석, 기간 분석 테스트 <br>
> 전체 학습 난이도 설정, 기간 학습 난이도 설정 테스트
3. **Controller**
> 전체 분석값, 기간 분석값 조회 테스트 <br>
> 난이도 조회 테스트

<br>
<br>

#### Amends
1. **Repository**
> Create, NotNull Attribute 테스트 <br>
> Read, 빈 Database 조회 테스트 <br>
> Update 테스트 <br>
> Delete 테스트
2. **Service**
> U 테스트 <br>
> Amends 조회 테스트
3. **Controller**
> 보상 조회 테스트 <br>
> 보상 입력 테스트 <br>
> 보상 재설정 테스트


## 배포

<img width="80%" src="https://user-images.githubusercontent.com/67732143/242211525-88d45540-d493-4f04-814b-ea2424da7ddc.jpg"/>

- 호스팅을 위한 AWS EC2 사용
- 클라우드 데이터베이스 접속을 위한 AWS RDS (Maria DB) 사용
- CI / CD를 위한 Jenkins 사용
- Github 코드를 이용하기 위한 Webhook 사용
- 무중단 배포를 위한 NGINX 사용 (Port : 8082, 8083)

> **프로필**
> 1. **real** - 내장 서버 사용 시 프로필 (application-real.properties)
> 2. **real1** - NGINX 사용 시 프로필 1 (application-real1.properties)
> 3. **real2** - NGINX 사용 시 프로필 2 (application-real2.properties)
> 
> ProfileController에서 프로필 판단 후 resources 연결

## 프로젝트 설치 방법
> git clone https://github.com/Sao-jung-listens-well/Backend.git

### 1. 개발 테스트 시
> src/main/resources에 존재하는 application.yml 사용 <br>
> localhost/h2-console 접속 후 데이터베이스 확인

### 2. 배포시 (AWS)
> src/main/resources에 application-real-db.properties 추가 <br>
> ssh 연결 후 지정 디렉토리에 application-real-db.properties 추가
```properties
#application-real-db.properties

spring.jpa.hibernate.ddl-auto=none
spring.jpa.show_sql=true

spring.datasource.hikari.jdbc-url=jdbc:mysql://[호스트]:[포트]/what-is-this
spring.datasource.hikari.username=[유저네임]
spring.datasource.hikari.password=[패스워드]
spring.datasource.hikari.driver-class-name=com.mysql.cj.jdbc.Driver
```
<br>

> ssh 연결 후 지정 디렉토리에 deploy.sh 추가 <br>
> 아래 deploy.sh는 NGINX가 연결되어 있다는 것을 전제로 합니다. <br>
> NGINX를 사용하지 않거나 다른 무중단 배포를 사용한다면 그에 맞게 바꾸셔야 합니다.
```shell
#!/bin/bash

REPOSITORY=[지정 디렉토리]

echo "> current profile"
REPONSE_CODE=$(curl -s -o /dev/null -w "%{http_code}" http://localhost/profile)
echo "> $RESPONSE_CODE"

if [ $RESPONSE_CODE -ge 400 ]
then
	CURRENT_PROFILE=real2
else
	CURRENT_PROFILE=$(curl -s http://localhost/profile)
fi

echo "> $CURRENT_PROFILE"

echo "> find pid activated"
if [ ${CURRENT_PROFILE} == real1 ]
then
        PREV_PORT=8082
else
        PREV_PORT=8083
fi
IDLE_PID=$(lsof -ti tcp:${PREV_PORT})

if [ -z ${IDLE_PID} ]
then
        echo "> There is no activated application"
else
        echo "> kill -15 $IDLE_PID"
fi

if [ ${CURRENT_PROFILE} == real1 ]
then
        IDLE_PROFILE=real2
        IDLE_PORT=8083
else
        IDLE_PROFILE=real1
        IDLE_PORT=8082
fi

echo "> Build file copy"
echo "> cp $REPOSITORY/zip/*.jar $REPOSITORY/"
sudo cp $REPOSITORY/zip/*.jar $REPOSITORY/

echo "> deploy new Application"
JAR_NAME=$(ls -tr $REPOSITORY/*.jar | tail -n 1)

echo "> JAR Name: $JAR_NAME"

echo "> add previlege"
sudo chmod +x $JAR_NAME

echo "> deploy $IDLE_PROFILE"
sudo fuser -k -n tcp $IDLE_PORT

sudo nohup java -jar \
	-Dspring.config.location=[지정 디렉토리]/application-real-db.properties,classpath:/application-$IDLE_PROFILE.properties \
        -Dspring.profiles.active=$IDLE_PROFILE \
        $JAR_NAME >> $REPOSITORY/nohup.out &

echo "> $IDLE_PROFILE Health Check"
echo "> curl -s http://localhost:$IDLE_PORT/profile"
sleep 10

for RETRY_COUNT in {1..10}
do
        RESPONSE=$(curl -s http://localhost:$IDLE_PORT/profile)
        UP_COUNT=$(echo ${RESPONSE} | grep 'real' | wc -l)

        if [ ${UP_COUNT} -ge 1 ]
        then
                echo "> Success Health check"
		break
	else
                echo "> Can't know Health check response or status is not UP"
                echo "> Health check: ${RESPONSE}"
        fi

	if [ $RETRY_COUNT -eq 10 ]
	then
		echo "> Fail to Health check"
		echo "> Not connect to Nginx and stop to deploy"
		exit 1
	fi

	echo "> Fail to connect to Health check. Retry... "
	sleep 10
done

echo "> Try to switch... "
sleep 10

echo "> Convert Port"
echo "set \$service_url http://127.0.0.1:${IDLE_PORT};" | sudo tee /etc/nginx/conf.d/service-url.inc

echo "> Nginx Reload"
sudo service nginx reload
```

## 버그
- 일부 자료형식에서 지정된 형식이 정해져있습니다. 사용하려는 Front 코드에서 이를 정확하게 맞추어야 합니다.
- 정보를 주고 받는 과정에서 고려되지 못한 exception이 있을 수 있습니다.

### 버그 수정 방법
1. 프로젝트를 fork합니다.
2. branch를 생성합니다.(```git checkout -b issue```)
3. 버그를 수정하고 커밋합니다.(```git commit -m 'Catch some Error'```)
4. branch를 push합니다. (```git push origin issue```)
5. Pull Request합니다.

## Contact
www.castlehi@gmail.com
